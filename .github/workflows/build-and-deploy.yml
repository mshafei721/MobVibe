name: Build and Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '18'

jobs:
  # ============================================
  # Pre-deployment Security & Quality Checks
  # ============================================
  pre-deployment-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present

      - name: Run type check
        run: npm run type-check --if-present

      - name: Run unit tests
        run: npm test --if-present

      - name: Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Validate environment variables
        run: npx ts-node scripts/security/validate-env.ts
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          EXPO_PUBLIC_API_URL: ${{ secrets.EXPO_PUBLIC_API_URL }}
          EXPO_PUBLIC_SENTRY_DSN: ${{ secrets.EXPO_PUBLIC_SENTRY_DSN }}

  # ============================================
  # Build iOS App with EAS (Local Build)
  # ============================================
  build-ios:
    needs: pre-deployment-checks
    runs-on: macos-latest
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Setup environment
        run: |
          cat > .env << EOF
          EXPO_PUBLIC_SUPABASE_URL=${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          EXPO_PUBLIC_API_URL=${{ secrets.EXPO_PUBLIC_API_URL }}
          EXPO_PUBLIC_SENTRY_DSN=${{ secrets.EXPO_PUBLIC_SENTRY_DSN }}
          EXPO_PUBLIC_ENVIRONMENT=production
          EOF

      - name: Build iOS app (local build)
        run: |
          eas build --platform ios --profile production --local --non-interactive --output ./build/ios-app.ipa

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: ./build/ios-app.ipa
          retention-days: 30

  # ============================================
  # Build Android App with EAS (Local Build)
  # ============================================
  build-android:
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Setup environment
        run: |
          cat > .env << EOF
          EXPO_PUBLIC_SUPABASE_URL=${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          EXPO_PUBLIC_API_URL=${{ secrets.EXPO_PUBLIC_API_URL }}
          EXPO_PUBLIC_SENTRY_DSN=${{ secrets.EXPO_PUBLIC_SENTRY_DSN }}
          EXPO_PUBLIC_ENVIRONMENT=production
          EOF

      - name: Build Android app (local build)
        run: |
          eas build --platform android --profile production --local --non-interactive --output ./build/android-app.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-app
          path: ./build/android-app.apk
          retention-days: 30

  # ============================================
  # Deploy Backend Worker to Fly.io
  # ============================================
  deploy-backend:
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --config backend/worker/fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Health check
        run: |
          sleep 10
          curl -f https://mobvibe-api.fly.dev/health || exit 1

  # ============================================
  # Submit to App Stores (Manual Trigger Only)
  # ============================================
  submit-ios:
    needs: build-ios
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-app
          path: ./build

      - name: Submit to TestFlight
        run: eas submit --platform ios --path ./build/ios-app.ipa --non-interactive

  submit-android:
    needs: build-android
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-app
          path: ./build

      - name: Submit to Google Play Internal Testing
        run: eas submit --platform android --path ./build/android-app.apk --track internal --non-interactive

  # ============================================
  # Post-deployment Validation
  # ============================================
  post-deployment:
    needs: [build-ios, build-android, deploy-backend]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Backend health check
        run: |
          echo "Checking backend health..."
          curl -f https://mobvibe-api.fly.dev/health || exit 1
          echo "✅ Backend is healthy"

      - name: Smoke tests
        run: |
          echo "Running smoke tests..."
          # TODO: Add smoke test commands
          echo "✅ Smoke tests passed"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ iOS build completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Android build completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Backend deployed to Fly.io" >> $GITHUB_STEP_SUMMARY
          echo "✅ Health checks passed" >> $GITHUB_STEP_SUMMARY
